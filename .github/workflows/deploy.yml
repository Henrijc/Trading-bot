name: Build and Deploy to VPS

on:
  # AUTOMATIC DEPLOYMENT DISABLED
  # Only runs when manually triggered from GitHub Actions tab
  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'Type "DEPLOY" to confirm deployment'
        required: true
        default: 'CANCEL'
  
  # AUTOMATIC TRIGGERS DISABLED:
  # push:
  #   branches: [ for-deployment ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: henrijc/trading-bot

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push backend image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: vps_deployment_package/docker/Dockerfile.backend.prod
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1

    - name: Build and push frontend image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: vps_deployment_package/docker/Dockerfile.frontend.prod
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1

    - name: Build and push freqtrade image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: vps_deployment_package/docker/Dockerfile.freqtrade.prod
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-freqtrade:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 156.155.253.224
        username: cryptoadmin
        key: ${{ secrets.VPS_SSH_C_BOT_KEY }}
        timeout: 1800s
        command_timeout: 2400s
        script: |
          # Login to GHCR
          echo "${{ secrets.GHCR_PAT }}" | sudo docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
          
          # Navigate to deployment directory
          cd /opt/crypto-coach || {
            sudo git clone --branch for-deployment https://github.com/Henrijc/Trading-bot.git /opt/crypto-coach
            cd /opt/crypto-coach
            sudo chown -R cryptoadmin:cryptoadmin /opt/crypto-coach
          }
          
          # Update to latest code
          git fetch --all
          git reset --hard origin/for-deployment
          
          # Stop existing containers gracefully
          sudo docker compose -f vps_deployment_package/docker/docker-compose.prod.yml --env-file /opt/crypto-coach/.env down --remove-orphans || true
          
          # Clean up old images to save space
          sudo docker system prune -f --volumes
          
          # Pull latest images
          sudo docker compose -f vps_deployment_package/docker/docker-compose.prod.yml --env-file /opt/crypto-coach/.env pull
          
          # Start all services
          sudo docker compose -f vps_deployment_package/docker/docker-compose.prod.yml --env-file /opt/crypto-coach/.env up -d --remove-orphans --force-recreate
          
          # Wait for services to be ready
          sleep 30
          
          # Verify deployment
          sudo docker compose -f vps_deployment_package/docker/docker-compose.prod.yml ps
          
          echo "Deployment completed successfully!"